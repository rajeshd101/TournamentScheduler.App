
@page "/"
@inject TournamentState State
@inject NavigationManager Nav

<div class="view-section active" style="max-width: 1200px; padding: 1.5rem;">
    
    <!-- 1. HEADER & TOURNAMENT MANAGEMENT -->
    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 2rem;">
        <div>
            <h1 style="font-size: 2.5rem; margin:0; color:var(--primary);">TourneyPro Setup</h1>
            <p class="subtitle" style="margin:0; font-size:1.1rem;">Configure your tournament parameters.</p>
        </div>
        
        <!-- Tournament Switcher (Compact) -->
        <div class="glass-panel" style="padding: 1rem; border:1px solid rgba(255,255,255,0.2); display:flex; gap:1.5rem; align-items:center;">
            <div style="display:flex; flex-direction:column;">
                <label style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:0.25rem;">Current Profile</label>
                <div style="font-weight:bold; font-size:1.1rem; color:var(--accent);">@State.TournamentName</div>
            </div>
            
            <div style="height:30px; border-left:1px solid var(--border);"></div>

            <div style="display:flex; gap:0.5rem; align-items:center;">
                <select @onchange="SwitchTournament" style="padding:0.4rem; font-size:0.9rem; width:150px;">
                    <option value="">Switch Profile...</option>
                    @foreach(var t in State.GetTournamentList())
                    {
                        <option value="@t" selected="@(t == State.TournamentName)">@t</option>
                    }
                </select>
                <span style="color:var(--text-muted); font-size:0.8rem;">or</span>
                <input type="text" @bind="NewTournamentName" placeholder="New Name" style="padding:0.4rem; font-size:0.9rem; width:120px;" />
                <button class="btn secondary" @onclick="CreateNewTournament" type="button" style="padding:0.4rem 0.8rem; font-size:0.9rem;">Create</button>
            </div>
        </div>
    </div>

    <!-- 2. MAIN CONFIGURATION FORM -->
    <EditForm Model="@State.Config" OnValidSubmit="HandleSubmit">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            
            <!-- LEFT: LOGISTICS -->
            <div class="card glass-panel" style="padding: 2rem;">
                <h3 style="margin-top:0; color:var(--primary); border-bottom:1px solid var(--border); padding-bottom:0.5rem; margin-bottom:1.5rem;">
                    <span style="font-size:1.2rem;">Core Logistics</span>
                </h3>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label>Number of Players</label>
                        <InputNumber @bind-Value="State.Config.NumPlayers" min="4" style="font-size:1.2rem; font-weight:bold;" />
                    </div>
                    <div class="form-group">
                        <label>Number of Courts</label>
                        <InputNumber @bind-Value="State.Config.Courts" min="1" style="font-size:1.2rem; font-weight:bold;" />
                    </div>
                </div>

                <div class="form-group" style="margin-top:2rem;">
                    <label style="margin-bottom:0.5rem; display:block;">Pairing Rule</label>
                    <select @bind="State.Config.GenderRule" style="width:100%; padding:0.75rem; font-size:1rem;">
                        <option value="Doubles">Doubles (M+M vs M+M or F+F vs F+F)</option>
                        <option value="Singles">Singles (M vs M or F vs F)</option>
                        <option value="MixedDouble">Mixed Doubles (M+F vs M+F)</option>
                    </select>
                </div>
            </div>

            <!-- RIGHT: TIMING -->
            <div class="card glass-panel" style="padding: 2rem;">
                <h3 style="margin-top:0; color:var(--accent); border-bottom:1px solid var(--border); padding-bottom:0.5rem; margin-bottom:1.5rem;">
                    <span style="font-size:1.2rem;">Timing & Schedule</span>
                </h3>

                 <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom:1.5rem;">
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="datetime-local" @bind="State.Config.StartTime" required />
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="datetime-local" @bind="State.Config.EndTime" required />
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label>Match Duration (min)</label>
                        <InputNumber @bind-Value="State.Config.Duration" min="1" />
                    </div>
                    <div class="form-group">
                        <label>Break Time (min)</label>
                        <InputNumber @bind-Value="State.Config.BreakTime" min="0" />
                    </div>
                </div>
            </div>

        </div>

        <!-- 3. STRATEGY -->
        <div class="card glass-panel" style="padding: 2rem; margin-bottom: 2rem;">
            <h3 style="margin-top:0; color:var(--text-main); border-bottom:1px solid var(--border); padding-bottom:0.5rem; margin-bottom:1.5rem;">
                Scheduling Strategy
            </h3>
            
            <div class="radio-group" style="gap: 1.5rem; display: flex; flex-direction: column;">
                 <label class="radio-card">
                    <input type="radio" name="mode" 
                           checked="@(State.Config.Mode == "balanced")" 
                           @onchange="@(() => { State.Config.Mode = "balanced"; })" />
                    <span class="radio-content" style="padding: 1.5rem;">
                        <span class="radio-title">Balanced Mix</span>
                        <span class="radio-desc">Maximize partner diversity. Optimization focuses on playing with different people.</span>
                    </span>
                </label>
                <label class="radio-card">
                    <input type="radio" name="mode" 
                           checked="@(State.Config.Mode == "complete")" 
                           @onchange="@(() => { State.Config.Mode = "complete"; })" />
                    <span class="radio-content" style="padding: 1.5rem;">
                        <span class="radio-title">Partner Coverage</span>
                        <span class="radio-desc">Strictly ensure every player partners with every other eligible player at least once.</span>
                    </span>
                </label>
            </div>
        </div>

        <!-- 4. DATA OPS (Collapsed visual priority) -->
        <div class="card glass-panel" style="padding: 1.5rem; background:rgba(0,0,0,0.1);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0; color:var(--text-muted); font-size:1rem;">Data Management & Cloud Sync</h4>
                <div style="display:flex; gap:0.5rem;">
                    <button class="btn secondary" @onclick="GenerateDemoPlayers" type="button" style="font-size:0.8rem; padding:0.4rem 0.8rem;">Load Demo Data</button>
                </div>
            </div>
            
            <div style="margin-top:1rem; display:flex; flex-direction:column; gap:0.5rem;">
                <label style="font-size:0.85rem; color:var(--text-muted);">Data Folder Location (Auto-Saves Here)</label>
                <div style="display:flex; gap:0.5rem; align-items:center;">
                    <input type="text" @bind="State.DataPath" placeholder="Folder Path" style="flex:1; font-size:0.9rem; padding:0.5rem;" />
                    <button type="button" class="btn secondary" style="font-size:0.8rem; padding:0.5rem;" @onclick="BrowseFolder">Browse...</button>
                    <button type="button" class="btn secondary" style="font-size:0.8rem; padding:0.5rem;" @onclick="SetOneDrivePath">OneDrive</button>
                    <button type="button" class="btn secondary" style="font-size:0.8rem; padding:0.5rem;" @onclick="SetGoogleDrivePath">GDrive</button>
                </div>
                
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-top:0.5rem;">
                    <label style="display:flex; align-items:center; gap:0.5rem; font-size:0.9rem; cursor:pointer;">
                        <input type="checkbox" @bind="State.AutoSaveEnabled" style="width:16px; height:16px;" />
                        Enable Auto-Save
                    </label>
                    <div style="display:flex; gap:0.5rem;">
                         <button class="btn secondary" @onclick="SaveData" type="button" style="padding:0.4rem 0.8rem; font-size:0.9rem;">Save Now</button>
                    </div>
                 </div>
            </div>
             @if (!string.IsNullOrEmpty(Message))
            {
                <div style="margin-top:0.5rem; color: #4caf50; font-size:0.9rem;">@Message</div>
            }
        </div>

        <!-- MAIN ACTION -->
        <div style="margin-top: 3rem; text-align: right;">
            <button type="submit" class="btn primary" style="font-size: 1.25rem; padding: 1rem 3rem; box-shadow: 0 4px 15px rgba(59,130,246,0.4);">
                Next: Manage Players &rarr;
            </button>
        </div>

    </EditForm>
</div>

@code {
    private string Message = "";
    private string NewTournamentName = "";

    protected override void OnInitialized()
    {
        // Ensure setup dates are always today's date
        var today = DateTime.Today;
        
        // Preserve the time but update the date to today
        State.Config.StartTime = today.Add(State.Config.StartTime.TimeOfDay);
        State.Config.EndTime = today.Add(State.Config.EndTime.TimeOfDay);
        
        State.OnChange += StateHasChanged;
    }

    private void SetOneDrivePath()
    {
        string oneDrive = System.Environment.GetEnvironmentVariable("OneDrive") ?? System.IO.Path.Combine(System.Environment.GetFolderPath(System.Environment.SpecialFolder.UserProfile), "OneDrive");
        if (System.IO.Directory.Exists(oneDrive))
        {
            State.DataPath = System.IO.Path.Combine(oneDrive, "TourneyPro");
            Message = "Path set to OneDrive/TourneyPro. Auto-save will use this folder.";
        }
        else Message = "OneDrive folder not found.";
    }

    private void SetGoogleDrivePath()
    {
        string userProfile = System.Environment.GetFolderPath(System.Environment.SpecialFolder.UserProfile);
        string[] paths = { 
            System.IO.Path.Combine(userProfile, "Google Drive"), 
            System.IO.Path.Combine(userProfile, "GoogleDrive"),
            "G:\\My Drive" 
        };
        
        foreach(var p in paths)
        {
            if (System.IO.Directory.Exists(p))
            {
                State.DataPath = System.IO.Path.Combine(p, "TourneyPro");
                Message = "Path set to Google Drive/TourneyPro. Auto-save will use this folder.";
                return;
            }
        }
        Message = "Google Drive folder not found.";
    }

    private void HandleSubmit()
    {
        Nav.NavigateTo("players");
    }

    private void SwitchTournament(ChangeEventArgs e)
    {
        var name = e.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(name))
        {
            State.LoadTournament(name);
            Message = $"Switched to {name}";
        }
    }

    private void CreateNewTournament()
    {
        if (!string.IsNullOrWhiteSpace(NewTournamentName))
        {
            State.NewTournament(NewTournamentName);
            Message = $"Created new tournament: {NewTournamentName}";
            NewTournamentName = "";
        }
    }

    private void SaveData()
    {
        try 
        {
            State.SaveData(State.DataPath);
            Message = $"Success! Data saved to {State.DataPath}";
        }
        catch(Exception ex)
        {
            Message = $"Error: {ex.Message}";
        }
    }

    private void LoadData()
    {
        // Deprecated manual load button removed from UI, as SwitchTournament handles loading logic now.
        // But if needed, we can keep logic.
        // The user just wants to choose location and auto save.
    }

    private void GenerateDemoPlayers()
    {
        State.GenerateDemoPlayers();
        Message = "Generated 40 players (20 Men, 20 Women).";
    }

    private async Task BrowseFolder()
    {
        try
        {
            // Use PowerShell to show a FolderBrowserDialog
            var script = "Add-Type -AssemblyName System.Windows.Forms; $d = New-Object System.Windows.Forms.FolderBrowserDialog; if ($d.ShowDialog() -eq 'OK') { Write-Output $d.SelectedPath }";
            
            var info = new System.Diagnostics.ProcessStartInfo
            {
                FileName = "powershell",
                Arguments = $"-noprofile -command \"{script}\"",
                RedirectStandardOutput = true,
                UseShellExecute = false,
                CreateNoWindow = true
            };

            using var process = System.Diagnostics.Process.Start(info);
            if (process != null)
            {
                var output = await process.StandardOutput.ReadToEndAsync();
                await process.WaitForExitAsync();
                
                var path = output.Trim();
                if (!string.IsNullOrWhiteSpace(path))
                {
                    State.DataPath = path;
                    Message = "Folder selected successfully.";
                }
            }
        }
        catch (Exception ex)
        {
            Message = "Unable to open folder picker: " + ex.Message;
        }
    }
}


@page "/schedule"
@inject TournamentState State
@inject SchedulerService Scheduler

<div class="view-section active">
    <div class="card glass-panel" style="padding:0; overflow:visible;"> <!-- Remove padding from main card to let sticky header touch edges -->
        
        <!-- Sticky Header Container -->
        <div style="position:sticky; top:0; z-index:100; background: var(--bg-app); border-bottom:1px solid var(--border); padding: 0.5rem 1rem 0.25rem 1rem; border-top-left-radius:1rem; border-top-right-radius:1rem;">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h1 style="font-size: 1.75rem; font-weight: 700; margin: 0; background: linear-gradient(135deg, var(--text-main) 0%, var(--text-muted) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">TourneyPro Schedule</h1>
                <div class="actions" style="display: flex; gap: 0.75rem; align-items:center;">
                    <button class="btn secondary" @onclick="PrintSchedule" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                        <span style="opacity: 0.7;">üñ®Ô∏è</span> Export PDF
                    </button>
                    @if (_isGenerateLocked)
                    {
                        <button class="btn secondary" @onclick="UnlockGenerate" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;" title="Click to unlock and regenerate">
                            <span>üîí</span> Unlock to Regenerate
                        </button>
                    }
                    else
                    {
                        <button class="btn primary" @onclick="Generate" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                            <span style="opacity: 0.7;">‚ö°</span> Generate
                        </button>
                    }
                </div>
            </div>

            @if (State.Schedule.Any())
            {
                var totalMatches = State.Schedule.Count;
                var totalRounds = State.Schedule.Max(m => m.Round);
                var remaining = State.Schedule.Count(m => !m.Score1.HasValue || !m.Score2.HasValue);
                var currentRoundGroup = State.Schedule
                                        .GroupBy(m => m.Round)
                                        .OrderBy(g => g.Key)
                                        .FirstOrDefault(g => g.Any(m => !m.Score1.HasValue || !m.Score2.HasValue));
                var currentRoundDisplay = currentRoundGroup != null ? $"{currentRoundGroup.Key}" : "-";

                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom:0.5rem; gap:0.5rem;">
                    <div class="stat-card" style="padding:0.75rem;">
                        <div class="stat-label" style="font-size:0.75rem; margin-bottom:0;">Total Matches</div>
                        <div class="stat-value" style="font-size:1.1rem;">@totalMatches</div>
                    </div>
                    <div class="stat-card" style="padding:0.75rem;">
                        <div class="stat-label" style="font-size:0.75rem; margin-bottom:0;">Total Rounds</div>
                        <div class="stat-value" style="font-size:1.1rem;">@totalRounds</div>
                    </div>
                    <div class="stat-card" style="padding:0.75rem;">
                        <div class="stat-label" style="font-size:0.75rem; margin-bottom:0;">Current Round</div>
                        <div class="stat-value" style="font-size:1.1rem;">@currentRoundDisplay</div>
                    </div>
                    <div class="stat-card" style="padding:0.75rem;">
                        <div class="stat-label" style="font-size:0.75rem; margin-bottom:0;">Remaining Matches</div>
                        <div class="stat-value" style="font-size:1.1rem;">@remaining</div>
                    </div>
                </div>
            }
        </div>

@inject IJSRuntime JS

@implements IDisposable
@inject NavigationManager Nav

<style>
    @@keyframes flash-text-amber {
        0% { text-shadow: 0 0 2px rgba(255, 193, 7, 0); color: inherit; }
        50% { text-shadow: 0 0 8px rgba(255, 193, 7, 0.8); color: #ffca28; }
        100% { text-shadow: 0 0 2px rgba(255, 193, 7, 0); color: inherit; }
    }

    .active-player-row {
        background: rgba(255, 193, 7, 0.05);
    }
    
    .active-player-text {
        animation: flash-text-amber 2s infinite ease-in-out;
        font-weight: bold;
    }

    .current-round-row {
        background: rgba(var(--primary-rgb), 0.1) !important;
        border-left: 4px solid var(--primary);
    }

    .completed-round-row {
        opacity: 0.5;
        filter: grayscale(0.8);
    }

    /* Simplified Layout for Schedule only */
    .schedule-layout {
        display: flex;
        flex-direction: column;
        width: 100%;
        /* No fixed height, let it grow */
    }
    
    .schedule-center { 
        width: 100%; 
    }

    .schedule-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
        padding-bottom: 2rem;
    }
    
    .sticky-col {
        position: sticky;
        left: 0;
        z-index: 10;
        /* Ensure background matches panel to hide scroll content behind it */
    }


</style>

@if (State.Schedule.Any())
{
    var activePlayers = GetActivePlayers();

    <div class="schedule-layout">
        <div class="schedule-center" style="display:flex; flex-direction:column; gap:1rem; overflow:hidden; max-width: 1200px; margin: 0 auto; width: 100%;">
            


        <div style="flex:1; overflow: auto; padding: 1.5rem; max-height: 70vh;">
            <table class="schedule-matrix-table" style="width:100%; border-collapse: separate; border-spacing: 0;">
                <thead style="position: sticky; top: 0; z-index: 20; background: var(--bg-panel);">
                    <tr>
                        <th class="sticky-col" style="background:var(--bg-panel); z-index:30; left:0; border-bottom:2px solid var(--border); padding:1rem; text-align:left; position: sticky; top: 0;">Round</th>
                            @for (int c = 1; c <= State.Config.Courts; c++)
                            {
                                <th style="border-bottom:2px solid var(--border); padding:1rem; text-align:center; min-width:200px; background:rgba(0,0,0,0.1); position: sticky; top: 0;">Court#@c</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var roundGroup in GetFilteredSchedule().GroupBy(m => m.Round).OrderBy(g => g.Key))
                        {
                            int round = roundGroup.Key;
                            string time = roundGroup.First().Time;
                            var matches = roundGroup.ToList();
                            bool isCurrent = IsRoundActive(time);
                            bool isCompleted = IsRoundCompleted(matches);
                            string rowClass = isCurrent ? "current-round-row" : (isCompleted ? "completed-round-row" : "");
                            
                            <tr class="@rowClass">
                                <!-- Round Header Column -->
                                <td class="sticky-col" style="background:var(--bg-panel); z-index:10; left:0; border-bottom:1px solid var(--border); padding:1rem; font-weight:bold; border-right:1px solid var(--border);">
                                    <div style="display:flex; flex-direction:column;">
                                        <span style="font-size:1.1rem; color:var(--primary);">Round @round</span>
                                        <span style="font-size:0.85rem; color:var(--text-muted); font-weight:normal;">@time</span>
                                    </div>
                                </td>

                                <!-- Court Cells -->
                                @for (int c = 1; c <= State.Config.Courts; c++)
                                {
                                    var match = matches.FirstOrDefault(m => m.Court == c);
                                    <td style="border-bottom:1px solid var(--border); padding:0.5rem; border-right:1px solid rgba(255,255,255,0.05); vertical-align:top;">
                                        @if (match != null)
                                        {
                                            <div style="background:rgba(255,255,255,0.03); border-radius:6px; padding:0.5rem; display:flex; flex-direction:column; gap:0.5rem;">
                                                <!-- Team 1 -->
                                                <div style="display:flex; gap:4px; justify-content:center; align-items:center;">
                                                    @if(match.ServingTeam == 1) { <span style="font-size:0.8rem;" title="Serves first">üèì</span> }
                                                    <div style="@GetPlayerStyle(match.P1)">@match.P1.Name</div>
                                                    <div style="@GetPlayerStyle(match.P2)">@match.P2.Name</div>
                                                </div>
                                                
                                                <div style="text-align:center; font-size:0.75rem; color:var(--text-muted); font-weight:bold;">VS</div>
                                                
                                                <!-- Team 2 -->
                                                <div style="display:flex; gap:4px; justify-content:center; align-items:center;">
                                                    @if(match.ServingTeam == 2) { <span style="font-size:0.8rem;" title="Serves first">üèì</span> }
                                                    <div style="@GetPlayerStyle(match.P3)">@match.P3.Name</div>
                                                    <div style="@GetPlayerStyle(match.P4)">@match.P4.Name</div>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div style="text-align:center; color:var(--text-muted); padding:1rem; opacity:0.5;">-</div>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <p style="text-align:center; padding: 2rem; color: var(--text-muted);">
        No schedule generated yet. Ensure you have enough players (min 4) and click Generate.
    </p>
}
    </div>
</div>

@code {
    private string Message = "";
    private bool IsGenerating = false;
    private bool _isGenerateLocked = false; // Lock generate after first use

    protected override void OnInitialized()
    {
        State.OnChange += StateHasChanged;
        State.OnSearchChanged += StateHasChanged; // Re-render on search
    }

    private IEnumerable<Match> GetFilteredSchedule()
    {
        if (string.IsNullOrWhiteSpace(State.SearchTerm)) return State.Schedule;
        return State.Schedule.Where(m => 
            m.P1.Name.Contains(State.SearchTerm, StringComparison.OrdinalIgnoreCase) ||
            m.P2.Name.Contains(State.SearchTerm, StringComparison.OrdinalIgnoreCase) ||
            m.P3.Name.Contains(State.SearchTerm, StringComparison.OrdinalIgnoreCase) ||
            m.P4.Name.Contains(State.SearchTerm, StringComparison.OrdinalIgnoreCase)
        );
    }
    
    public void Dispose()
    {
        State.OnChange -= StateHasChanged;
        State.OnSearchChanged -= StateHasChanged;
    }

    private bool IsGenerationDisabled
    {
        get
        {
            // Disable 15 mins before StartTime
            // Since StartTime is now Full DateTime, we use it directly.
            var start = State.Config.StartTime;
            var now = DateTime.Now;
            
            // If now is >= (Start - 15min), it's close or started.
            return now >= start.AddMinutes(-15);
        }
    }

    private async Task PrintSchedule()
    {
        await JS.InvokeVoidAsync("triggerPrint");
    }

    private void Generate()
    {
        // Only include players who are NOT Out
        var activePlayers = State.Players.Where(p => !p.IsOut).ToList();
        
        if (activePlayers.Count < 4) 
        {
            return; 
        }

        var result = Scheduler.Generate(activePlayers, State.Config);
        State.SetSchedule(result);
        _isGenerateLocked = true; // Lock after generation
    }

    private void UnlockGenerate()
    {
        _isGenerateLocked = false;
    }

    private string GetPlayerStyle(Player p)
    {
         var recent = State.Players.FirstOrDefault(x => x.Id == p.Id);
         string color = recent?.Color ?? "#333";
         string textColor = State.GetContrastColor(color);
         return $"background-color: {color}; color: {textColor}; padding: 2px 6px; border-radius: 4px; font-weight: 500; font-size: 0.85rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;";
    }

    private HashSet<string> GetActivePlayers()
    {
        var active = new HashSet<string>();
        // Identify active round
        var roundGroups = State.Schedule.GroupBy(m => m.Round);
        foreach(var g in roundGroups)
        {
            if (IsRoundActive(g.First().Time))
            {
                foreach(var m in g)
                {
                    active.Add(m.P1.Id);
                    active.Add(m.P2.Id);
                    active.Add(m.P3.Id);
                    active.Add(m.P4.Id);
                }
            }
        }
        return active;
    }

    private bool IsRoundActive(string timeStr)
    {
        if (string.IsNullOrWhiteSpace(timeStr)) return false;
        
        // Try DateTime first (New Format)
        if (DateTime.TryParse(timeStr, out var startTime))
        {
            var now = DateTime.Now;
            var duration = TimeSpan.FromMinutes(State.Config.Duration + State.Config.BreakTime);
            return now >= startTime && now < startTime.Add(duration);
        }

        // Fallback TimeOnly (Old Format)
        if (TimeOnly.TryParse(timeStr, out var t))
        {
            var now = TimeOnly.FromDateTime(DateTime.Now);
            var duration = TimeSpan.FromMinutes(State.Config.Duration + State.Config.BreakTime);
            return now >= t && now < t.Add(duration);
        }
        return false;
    }

    private bool IsRoundCompleted(List<Match> matches)
    {
        // A round is completed if all matches in it have scores
        return matches.All(m => m.Score1.HasValue && m.Score2.HasValue);
    }

    private IEnumerable<(string Name, int Total, int Played, int Remaining)> GetPlayerStats(string gender)
    {
        var targetPlayers = State.Players.Where(p => string.Equals(p.Gender, gender, StringComparison.OrdinalIgnoreCase)).ToDictionary(p => p.Id, p => p.Name);
        var stats = targetPlayers.Keys.ToDictionary(k => k, k => (Total: 0, Played: 0));

        foreach(var m in State.Schedule)
        {
            void AddStat(string pid)
            {
                if (!stats.ContainsKey(pid)) return; 
                var current = stats[pid];
                current.Total++;
                if (m.Score1.HasValue || m.Score2.HasValue) current.Played++;
                stats[pid] = current;
            }

            AddStat(m.P1.Id);
            AddStat(m.P2.Id);
            AddStat(m.P3.Id);
            AddStat(m.P4.Id);
        }

        return stats.Select(k => 
        {
            return (Name: targetPlayers[k.Key], Total: k.Value.Total, Played: k.Value.Played, Remaining: k.Value.Total - k.Value.Played);
        })
        .OrderByDescending(x => x.Total)
        .ThenByDescending(x => x.Played)
        .ThenBy(x => x.Name);
    }
}

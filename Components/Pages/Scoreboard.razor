@page "/scoreboard"
@inject TournamentState State
@implements IDisposable

<style>
    .scoreboard-container {
        background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 100%);
        min-height: 100vh;
        padding: 1rem;
        color: white;
        font-family: 'Segoe UI', sans-serif;
    }
    
    .scoreboard-header {
        text-align: center;
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .scoreboard-header h1 {
        font-size: 2.5rem;
        background: linear-gradient(135deg, gold, #ffd700);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
    }
    
    .scoreboard-header .subtitle {
        color: rgba(255,255,255,0.6);
        font-size: 1rem;
        margin-top: 0.5rem;
    }
    
    .scoreboard-grid {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 1rem;
        height: calc(100vh - 150px);
    }
    
    .leaderboard-panel {
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid rgba(255,255,255,0.1);
        overflow: hidden;
    }
    
    .leaderboard-panel h2 {
        text-align: center;
        margin: 0 0 1rem 0;
        font-size: 1.3rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .leaderboard-panel.men h2 { color: #42a5f5; }
    .leaderboard-panel.women h2 { color: #f06292; }
    
    .player-row {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        background: rgba(255,255,255,0.03);
    }
    
    .player-row.rank-1 { background: rgba(255,215,0,0.2); }
    .player-row.rank-2 { background: rgba(192,192,192,0.15); }
    .player-row.rank-3 { background: rgba(205,127,50,0.15); }
    
    .rank-badge {
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-right: 0.75rem;
    }
    
    .player-info {
        flex: 1;
    }
    
    .player-name {
        font-weight: bold;
        font-size: 1rem;
    }
    
    .player-stats {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.6);
    }
    
    .matches-panel {
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid rgba(255,255,255,0.1);
        overflow-y: auto;
    }
    
    .matches-panel h2 {
        text-align: center;
        margin: 0 0 1rem 0;
        color: #ffd700;
    }
    
    .match-card {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.05);
    }
    
    .match-card.active {
        border-color: rgba(255,193,7,0.5);
        background: rgba(255,193,7,0.1);
    }
    
    .team {
        text-align: center;
    }
    
    .team-names {
        font-size: 0.9rem;
    }
    
    .team-score {
        font-size: 1.5rem;
        font-weight: bold;
        margin-top: 0.25rem;
    }
    
    .vs-badge {
        padding: 0.25rem 0.5rem;
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
        font-size: 0.75rem;
        color: rgba(255,255,255,0.5);
    }
    
    .court-badge {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.4);
        margin-top: 0.25rem;
    }
    
    .refresh-info {
        text-align: center;
        padding: 0.5rem;
        color: rgba(255,255,255,0.4);
        font-size: 0.8rem;
    }
</style>

<div class="scoreboard-container">
    <div class="scoreboard-header">
        <h1>üèÜ Tournament Scoreboard</h1>
        <div class="subtitle">@State.TournamentName ‚Ä¢ Live Updates</div>
    </div>
    
    <div class="scoreboard-grid">
        <!-- Men's Leaderboard -->
        <div class="leaderboard-panel men">
            <h2>üèÖ Men's Top 10</h2>
            @foreach (var p in GetTopPlayers("M").Take(10))
            {
                var medal = p.Rank == 1 ? "ü•á" : p.Rank == 2 ? "ü•à" : p.Rank == 3 ? "ü•â" : $"#{p.Rank}";
                <div class="player-row rank-@p.Rank">
                    <div class="rank-badge">@medal</div>
                    <div class="player-info">
                        <div class="player-name">@p.Name</div>
                        <div class="player-stats">@p.Points pts ‚Ä¢ @p.Wins W / @p.Losses L</div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Current Matches -->
        <div class="matches-panel">
            <h2>üìä Current Round Matches</h2>
            @{
                var activeRound = GetActiveRound();
                var roundMatches = State.Schedule.Where(m => m.Round == activeRound).OrderBy(m => m.Court).ToList();
            }
            @if (roundMatches.Any())
            {
                <div style="text-align:center; margin-bottom:1rem; color:rgba(255,255,255,0.6);">
                    Round @activeRound ‚Ä¢ @roundMatches.First().Time
                </div>
                @foreach (var match in roundMatches)
                {
                    <div class="match-card active">
                        <div class="team">
                            <div class="team-names">@match.P1.Name<br/>@match.P2.Name</div>
                            <div class="team-score">@(match.Score1?.ToString() ?? "-")</div>
                        </div>
                        <div style="text-align:center;">
                            <div class="vs-badge">VS</div>
                            <div class="court-badge">Court @match.Court</div>
                        </div>
                        <div class="team">
                            <div class="team-names">@match.P3.Name<br/>@match.P4.Name</div>
                            <div class="team-score">@(match.Score2?.ToString() ?? "-")</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="text-align:center; color:rgba(255,255,255,0.5); padding:2rem;">
                    No active matches
                </div>
            }
        </div>
        
        <!-- Women's Leaderboard -->
        <div class="leaderboard-panel women">
            <h2>üèÖ Women's Top 10</h2>
            @foreach (var p in GetTopPlayers("F").Take(10))
            {
                var medal = p.Rank == 1 ? "ü•á" : p.Rank == 2 ? "ü•à" : p.Rank == 3 ? "ü•â" : $"#{p.Rank}";
                <div class="player-row rank-@p.Rank">
                    <div class="rank-badge">@medal</div>
                    <div class="player-info">
                        <div class="player-name">@p.Name</div>
                        <div class="player-stats">@p.Points pts ‚Ä¢ @p.Wins W / @p.Losses L</div>
                    </div>
                </div>
            }
        </div>
    </div>
    
    <div class="refresh-info">
        Auto-refreshes every 15 seconds ‚Ä¢ Open this URL on any display: http://localhost:5000/scoreboard
    </div>
</div>

@code {
    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        State.OnChange += StateHasChanged;
        // Auto-refresh every 15 seconds for live display
        _timer = new System.Threading.Timer(_ => 
        {
            InvokeAsync(StateHasChanged);
        }, null, 0, 15000);
    }

    public void Dispose()
    {
        State.OnChange -= StateHasChanged;
        _timer?.Dispose();
    }

    private int GetActiveRound()
    {
        var now = DateTime.Now;
        foreach (var g in State.Schedule.GroupBy(m => m.Round).OrderBy(g => g.Key))
        {
            if (DateTime.TryParse(g.First().Time, out var roundTime))
            {
                var roundEnd = roundTime.AddMinutes(State.Config.Duration + State.Config.BreakTime);
                if (now >= roundTime && now < roundEnd) return g.Key;
            }
        }
        // Return latest round with incomplete scores
        var incomplete = State.Schedule
            .Where(m => !m.Score1.HasValue || !m.Score2.HasValue)
            .OrderBy(m => m.Round)
            .FirstOrDefault();
        return incomplete?.Round ?? State.Schedule.Max(m => m.Round);
    }

    private List<PlayerRanking> GetTopPlayers(string gender)
    {
        var stats = new Dictionary<string, (int wins, int losses, int points)>();
        
        foreach (var m in State.Schedule.Where(m => m.Score1.HasValue && m.Score2.HasValue))
        {
            var team1Ids = new[] { m.P1.Id, m.P2.Id };
            var team2Ids = new[] { m.P3.Id, m.P4.Id };
            
            bool team1Wins = m.Score1 > m.Score2;
            int diff = Math.Abs((m.Score1 ?? 0) - (m.Score2 ?? 0));
            
            foreach (var id in team1Ids)
            {
                if (!stats.ContainsKey(id)) stats[id] = (0, 0, 0);
                var s = stats[id];
                stats[id] = team1Wins ? (s.wins + 1, s.losses, s.points + diff) : (s.wins, s.losses + 1, s.points);
            }
            foreach (var id in team2Ids)
            {
                if (!stats.ContainsKey(id)) stats[id] = (0, 0, 0);
                var s = stats[id];
                stats[id] = !team1Wins ? (s.wins + 1, s.losses, s.points + diff) : (s.wins, s.losses + 1, s.points);
            }
        }
        
        return State.Players
            .Where(p => string.Equals(p.Gender, gender, StringComparison.OrdinalIgnoreCase))
            .Select(p => new PlayerRanking
            {
                Name = p.Name,
                Wins = stats.ContainsKey(p.Id) ? stats[p.Id].wins : 0,
                Losses = stats.ContainsKey(p.Id) ? stats[p.Id].losses : 0,
                Points = stats.ContainsKey(p.Id) ? stats[p.Id].points : 0
            })
            .OrderByDescending(p => p.Points)
            .ThenByDescending(p => p.Wins)
            .Select((p, i) => { p.Rank = i + 1; return p; })
            .ToList();
    }

    private class PlayerRanking
    {
        public string Name { get; set; } = "";
        public int Wins { get; set; }
        public int Losses { get; set; }
        public int Points { get; set; }
        public int Rank { get; set; }
    }
}
